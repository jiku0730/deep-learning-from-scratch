name: Auto Copilot Review (JA)

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

permissions:
  pull-requests: write
  issues: write

jobs:
  request-and-instruct:
    runs-on: ubuntu-latest
    steps:
      - name: Request Copilot as reviewer
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            // ã™ã§ã«CopilotãŒãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            const reviewers = pr.requested_reviewers?.map(r => r.login) || [];
            if (!reviewers.includes('github-copilot')) {
              await github.request('POST /repos/{owner}/{repo}/pulls/{pull_number}/requested_reviewers', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: ['github-copilot']
              });
              core.info('Requested review from github-copilot');
            } else {
              core.info('Copilot already requested. Skipping.');
            }

      - name: Post JA instruction comment (idempotent)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // é‡è¤‡æŠ•ç¨¿é˜²æ­¢ï¼šåŒå†…å®¹ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒæ—¢ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const list = await github.request(
              'GET /repos/{owner}/{repo}/issues/{issue_number}/comments',
              { owner, repo, issue_number: pr.number, per_page: 100 }
            );
            const body = [
              'ğŸ‘‹ Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸã€‚',
              'ä»¥ä¸‹ã®æŒ‡ç¤ºã§ **æ—¥æœ¬èªãƒ¬ãƒ“ãƒ¥ãƒ¼** ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š',
              'ã€Œã“ã®PRã‚’æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚å¯èª­æ€§ãƒ»å‘½åãƒ»ä¾‹å¤–å‡¦ç†ãƒ»ãƒ†ã‚¹ãƒˆã®è¦³ç‚¹ã§å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã€å¿…è¦ãªã‚‰ä¿®æ­£æ¡ˆã‚³ãƒ¼ãƒ‰ã‚‚æç¤ºã—ã¦ãã ã•ã„ã€‚ã€'
            ].join('\n');

            const exists = (list.data || []).some(c => (c.body || '').includes('Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸã€‚'));
            if (!exists) {
              await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
                owner, repo, issue_number: pr.number, body
              });
              core.info('Posted JA instruction comment.');
            } else {
              core.info('Instruction comment already exists. Skipping.');
            }
